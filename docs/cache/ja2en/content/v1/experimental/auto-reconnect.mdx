---
title: Auto Reconnection
banner:
  content: This is an experimental feature, and the API is subject to frequent changes.
---

This feature provides automatic reconnection attempts in response to connection interruptions that occur in real-time communication, such as with WebSockets. It utilizes a predefined logic for reconnection attempts and emits events indicating success or failure.

The `autoReconnect` function creates an instance of the `AutoReconnect` class, enabling the use of the reconnection functionality.

### Import

```ts
import { autoReconnect } from "@tai-kun/surrealdb";
```

### Syntax

```ts
function autoReconnect(
  db: Client, 
  options?: AutoReconnectOptions
): AutoReconnect;
```

#### Arguments

##### `db`

An instance object of the `Surreal` class.

##### `options`

Options to specify reconnection settings. You can configure reconnection intervals, maximum delays, reconnection conditions, etc. If you want to use the default settings, you can omit this argument.

`backoffLimit?: number`
:   Specifies the maximum number of reconnection attempts. The default value is `Infinity`.

`initialDelay?: number`
:   The delay time (in milliseconds) before the first reconnection attempt is made. The default value is `500`.

`maxDelay?: number`
:   The maximum value for the reconnection delay time (in milliseconds). As the backoff progresses, the delay increases, but this value acts as the upper limit. The default value is `30_000` (30 seconds).

`shouldReconnect?: { ping?: { threshold: number; perMillis: number }} | (error) => boolean`
:   Specifies the conditions for reconnection. If a function is specified, it determines whether to reconnect based on the arguments of the error event.

#### Return Value

Returns an instance of the `AutoReconnect` class. This instance can be used for controlling and managing reconnections, retrieving status information, and monitoring events.

`.getReconnectionInfo(): ReconnectionInfo`
:   Retrieves the current reconnection information (`.state` and `.phase`). Each value indicates the following:
:   `.state`:
    - `"waiting"` ... Initial state. No reconnection attempts have been made.
    - `"running"` ... Reconnecting.
    - `"success"` ... Reconnection successful.
    - `"failure"` ... Reconnection failed.
:   `.phase`:
    - `"waiting"`       ... Initial state. No reconnection attempts have been made.
    - `"pending"`       ... Reconnection is requested and waiting for a specific duration before execution.
    - `"disconnecting"` ... Disconnecting.
    - `"connecting"`    ... Connecting. Tries to connect even if disconnection fails.
    - `"succeeded"`     ... Reconnection successful.
    - `"failed"`        ... Reconnection failed.

| state       | phase                           |
| ----------- | ------------------------------- |
| `"waiting"` | `"waiting"\|"pending"`          |
| `"running"` | `"disconnecting"\|"connecting"` |
| `"success"` | `"pending"\|"succeeded"`        |
| `"failure"` | `"pending"\|"failed"`           |

`.enable(): void`
:   Enables the reconnection feature. Reconnections will occur after calling this method. It is enabled by default.

`.disable(): void`
:   Disables the reconnection feature. Calling this method disables reconnections.

`.reset(): void`
:   Resets the reconnection counter. This initializes the reconnection backoff logic.

`.enabled: boolean`
:   A boolean value indicating whether the reconnection feature is enabled. `true` indicates that reconnection is enabled.

### Example

```ts
import { autoReconnect, Surreal } from "@tai-kun/surrealdb";

const db = new Surreal();
const ar = autoReconnect(db, {
  initialDelay: 1000,
  maxDelay: 30000,
  backoffLimit: 5,
  shouldReconnect: {
    ping: {
      perMillis: 60000, // Within 1 minute,
      threshold: 3,     // If 3 or more ping failures occur, reconnect.
    },
  },
});

ar.on("pending", (endpoint, duration) => {
  console.log(`${duration / 1000} seconds later, reconnecting to ${endpoint}...`);
});

ar.on("success", (endpoint) => {
  console.log(`Reconnection to ${endpoint} successful ðŸŽ‰`);
});

ar.on("failure", (endpoint, cause) => {
  console.error(`Reconnection to ${endpoint} failed ðŸ¤¯`);
  console.error("Cause:", cause);
});

try {
  await db.connect("ws://127.0.0.1:8000");

  // Various processes that run for an extended period

} finally {
  await db.disconnect();
}
```

### Notes

- The reconnection logic is crucial for ensuring the stability of WebSocket connections and adjusting the frequency of connection recovery. You need to adjust the option settings based on the system requirements and use cases.
- `autoReconnect` attempts to recover lost connections but does not guarantee complete recovery in all cases.
