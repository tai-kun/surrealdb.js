---
title: TaskQueue
---

import { Aside } from "@astrojs/starlight/components";
import Badge from "~/components/en/Badge.astro";

`TaskQueue` is a class for managing asynchronous tasks. It does not provide any means to control concurrency, as all task runners are executed asynchronously. 

### Import

```ts
import { TaskQueue } from "@tai-kun/surrealdb/utils";
```

### `.constructor()`

```ts
new TaskQueue();
```

#### Arguments

None.

#### Returns

When called with `new`, `TaskQueue` returns its instance.

### `.count` <Badge variant="instance" /><Badge variant="property" /><Badge variant="readonly" />

Represents the number of task runners currently added to the queue.

### `.add()` <Badge variant="instance" /><Badge variant="method" />

`.add()` adds a task runner to the queue.

```ts
add<T>(
  runner: (args: TaskRunnerArgs) => T | PromiseLike<T>,
  options?: TaskOptions,
): StatefulPromise<T>;
```

<Aside type="caution">
  If the task runner is expected to have a long execution time, it is recommended to immediately interrupt the task when the abort signal passed to the task runner receives an abort event. 
</Aside>

#### Arguments

##### `runner`

The task runner. The task runner will receive `TaskRunnerArgs` as its argument, which includes an abort signal `signal`.

##### `options`

Options for the task runner. You can pass an abort signal for this task runner.

#### Returns

Returns a `StatefulPromise` that resolves with the return value of the task runner.

#### Example

```ts
import { TaskQueue } from "@tai-kun/surrealdb/utils";

const queue = new TaskQueue();
const promise = queue.add(async ({ signal }) => {
  const response = await fetch("https://example.com/", { signal });
  return await response.text();
});

const text = await promise;
console.log(text);
```

### `.idle()` <Badge variant="instance" /><Badge variant="method" />

`.idle()` is a function that waits until the queue becomes empty. Task runners are removed from the queue immediately after they are completed, regardless of whether they are resolved or rejected. Therefore, an empty queue means that all task runners have finished executing.

```ts
idle(): StatefulPromise<void>;
```

<Aside type="caution">
  `.idle` will not catch errors thrown by the task runners added with the `.add` method. Since the task runners are executed within a `StatefulPromise`, you will not be able to notice any errors in the task runners without error handling.
</Aside>

#### Arguments

None.

#### Returns

Returns a `StatefulPromise` that resolves with `void`.

#### Example

The following example waits for the task runners added to the queue to finish, regardless of whether they are resolved or rejected:

```ts
import { TaskQueue } from "@tai-kun/surrealdb/utils";

const queue = new TaskQueue();
const results: string[] = [];
queue.add(async () => {
  results.push("Hello");
});
queue.add(() => {
  throw null;
});

console.log(queue.count);

await queue.idle();

console.log(queue.count);
console.log(results);
```

Output:

```js
2
0
[ 'Hello' ]
```

In the example above, `throw null` is not caught anywhere, and the script will finish successfully. To notice errors in task runners, you need to handle them individually.

### `.abort()` <Badge variant="instance" /><Badge variant="method" />

`.abort()` is a function that dispatches an abort event to the `signal` of all task runners. 

```ts
abort(reason?: unknown): void;
```

#### Arguments

##### `reason`

The reason for aborting.

#### Returns

None.
