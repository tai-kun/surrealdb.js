---
title: TaskQueue
slug: en/v2/api/utils/task-queue
---

import { Aside } from "@astrojs/starlight/components";
import Badge from "~/components/en/Badge.astro";

`TaskQueue` is a class that manages asynchronous tasks. There is no way to control concurrency. All task runners execute asynchronously.

### Import

```ts
import { TaskQueue } from "@tai-kun/surrealdb/utils";
```

### `.constructor()`

```ts
new TaskQueue();
```

#### Arguments

None.

#### Return Value

When called through `new`, `TaskQueue` returns its instance.

### `.count` <Badge variant="instance" /><Badge variant="property" /><Badge variant="readonly" />

Represents the number of task runners currently added to the queue.

### `.add()` <Badge variant="instance" /><Badge variant="method" />

`.add` adds a task runner to the queue.

```ts
add<T>(
  runner: (args: TaskRunnerArgs) => T | PromiseLike<T>,
  options?: TaskOptions,
): StatefulPromise<T>;
```

<Aside type="caution">
  If a task runner may take a long time to execute, it is recommended that the task runner immediately abort the task when it receives an abort event from the abort signal passed to it.
</Aside>

#### Arguments

##### `runner`

The task runner. The argument to the task runner is `TaskRunnerArgs`, which contains the abort signal `signal`.

##### `options`

The options for the task runner. The abort signal for this task runner can be passed.

#### Return Value

Returns a `StatefulPromise` that resolves with the return value of the task runner.

#### Example

```ts
import { TaskQueue } from "@tai-kun/surrealdb/utils";

const queue = new TaskQueue();
const promise = queue.add(async ({ signal }) => {
  const response = await fetch("https://example.com/", { signal });
  return await response.text();
});

const text = await promise;
console.log(text);
```

### `.idle()` <Badge variant="instance" /><Badge variant="method" />

`.idle` is a function to wait until the queue is empty. A task runner is removed from the queue immediately after it completes, whether it resolves or rejects. Therefore, an empty queue means that all task runners have finished executing.

```ts
idle(): StatefulPromise<void>;
```

<Aside type="caution">
  `.idle` does not catch errors thrown by task runners added with the `.add` method. Since task runners are executed within a `StatefulPromise`, errors in the task runner cannot be noticed without error handling.
</Aside>

#### Arguments

None.

#### Return Value

Returns a `StatefulPromise` that resolves with `void`.

#### Example

In the following example, we wait for all task runners added to the queue to finish, regardless of whether they resolve or reject:

```ts
import { TaskQueue } from "@tai-kun/surrealdb/utils";

const queue = new TaskQueue();
const results: string[] = [];
queue.add(async () => {
  results.push("Hello");
});
queue.add(() => {
  throw null;
});

console.log(queue.count);

await queue.idle();

console.log(queue.count);
console.log(results);
```

Output:

```js
2
0
[ 'Hello' ]
```

In the above example, `throw null` is not caught anywhere and the script exits normally. To notice task runner errors, you need to handle errors individually.

### `.abort()` <Badge variant="instance" /><Badge variant="method" />

`.abort` is a function that sends an abort event to the `signal` of all task runners.

```ts
abort(reason?: unknown): void;
```

#### Arguments

##### `reason`

The reason for the abort.

#### Return Value

None.
