---
title: Automatic Reconnection
banner:
  content: This is an experimental feature and the API may change frequently.
---

This feature provides automatic reconnection attempts upon connection interruptions, such as those occurring with WebSockets, in real-time communication. Reconnection follows specific logic, and events are emitted upon success or failure.

The `autoReconnect` function creates an instance of the `AutoReconnect` class, enabling the utilization of the reconnection functionality.

### Import

```ts
import { autoReconnect } from "@tai-kun/surrealdb";
```

### Syntax

```ts
function autoReconnect(
  db: Client, 
  options?: AutoReconnectOptions
): AutoReconnect;
```

#### Parameters

##### `db`

An instance object of the `Surreal` class.

##### `options`

Options for configuring reconnection behavior. Allows you to specify the reconnection interval, maximum delay, reconnection conditions, etc. It can be omitted if using the default settings.

`backoffLimit?: number`
:   Specifies the maximum number of reconnection attempts. Defaults to `Infinity`.

`initialDelay?: number`
:   The delay time (in milliseconds) before the first reconnection attempt. Defaults to `500`.

`maxDelay?: number`
:   The maximum delay time (in milliseconds) between reconnection attempts. The delay increases with each backoff but is capped at this value. Defaults to `30_000` (30 seconds).

`shouldReconnect?: { ping?: { threshold: number; perMillis: number }} | (error) => boolean`
:   Specifies the condition for triggering a reconnection. When a function is provided, it will determine whether to attempt reconnection based on the arguments of the error event.

#### Return Value

Returns an instance of the `AutoReconnect` class. This instance can be used to control reconnection, retrieve the current state, and monitor events.

`.getReconnectionInfo(): ReconnectionInfo`
:   Gets the current reconnection information (`.state` and `.phase`), which have the following meanings:
:   `.state`:
    - `"waiting"` ... Initial state. No reconnection attempts have been made.
    - `"running"` ... Reconnecting.
    - `"success"` ... Reconnection successful.
    - `"failure"` ... Reconnection failed.
:   `.phase`:
    - `"waiting"`    ... Initial state. No reconnection attempts have been made.
    - `"pending"`    ... Reconnection has been requested and is waiting for a certain period before execution.
    - `"closing"`    ... Disconnecting.
    - `"connecting"` ... Connecting. It will attempt to connect even if disconnection fails.
    - `"succeeded"`  ... Reconnection successful.
    - `"failed"`     ... Reconnection failed.

| state       | phase                     |
| ----------- | ------------------------- |
| `"waiting"` | `"waiting"\|"pending"`    |
| `"running"` | `"closing"\|"connecting"` |
| `"success"` | `"pending"\|"succeeded"`  |
| `"failure"` | `"pending"\|"failed"`     |

`.enable(): void`
:   Enables the reconnection functionality. Calling this method allows reconnection attempts to occur. Enabled by default.

`.disable(): void`
:   Disables the reconnection functionality. Calling this method prevents any further reconnection attempts.

`.reset(): void`
:   Resets the reconnection counter. This reinitializes the backoff logic for reconnection attempts.

`.enabled: boolean`
:   A boolean value indicating whether the reconnection functionality is enabled. `true` means reconnection is enabled.

### Example

```ts
import { autoReconnect, Surreal } from "@tai-kun/surrealdb";

const db = new Surreal();
const ar = autoReconnect(db, {
  initialDelay: 1000,
  maxDelay: 30000,
  backoffLimit: 5,
  shouldReconnect: {
    ping: {
      perMillis: 60000, // Within 1 minute,
      threshold: 3,     // if ping fails 3 times or more, reconnect.
    },
  },
});

ar.on("pending", (endpoint, duration) => {
  console.log(`Reconnecting to ${endpoint} in ${duration / 1000} seconds...`);
});

ar.on("success", (endpoint) => {
  console.log(`Reconnection to ${endpoint} successful ðŸŽ‰`);
});

ar.on("failure", (endpoint, cause) => {
  console.error(`Reconnection to ${endpoint} failed ðŸ¤¯`);
  console.error("Cause:", cause);
});

try {
  await db.connect("ws://127.0.0.1:8000");

  // Various operations that run for an extended period

} finally {
  await db.close();
}
```

### Note

- The reconnection logic is crucial for ensuring the stability of the WebSocket connection and the frequency of connection recovery. Adjust the option settings according to your system requirements and use case.
- `autoReconnect` attempts to recover from a lost connection but does not guarantee complete recovery in all cases.
