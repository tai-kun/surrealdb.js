---
title: 连接
slug: zh-CN/v1/guides/connecting
---

import Badge from "~/components/zh-CN/Badge.astro";

### 导入

```ts
import { Surreal } from "@tai-kun/surrealdb";
```

### `.constructor()`

```ts
new Surreal();
```

#### 参数

无。

#### 返回值

通过 `new` 调用时，`Surreal` 将返回其实例。

### `.connect()` <Badge variant="instance" /><Badge variant="method" />

连接到 SurrealDB 端点。此方法是异步的，但不会与同一实例中的其他 `.connect()` 或 `.disconnect()` 重叠执行。

```ts
connect(
  endpoint: string | URL,
  options?: ClientConnectOptions,
): Promise<void>;
```

#### 参数

##### `endpoint`

使用 URL 指定 SurrealDB 端点。如果 URL 路径的末尾不是 `/rpc`，则会自动添加。因此，将 `http://localhost:8000` 作为参数传递将连接到 `http://localhost:8000/rpc`。

##### `options`

连接时的选项。

`signal?: AbortSignal`
:   连接中断的信号。默认情况下，将设置一个在 15 秒后超时的中断信号。

#### 返回值

返回一个以 `undefined` 解析的 `Promise` 对象。

#### 例子

以下示例使用 WebSocket 协议连接到 SurrealDB：

```ts
import { Surreal } from "@tai-kun/surrealdb";

const db = new Surreal();

await db.connect("ws://localhost:8000");
```

无法在没有 `.disconnect()` 断开连接的情况下连接到不同的端点。另外，先前建立连接的端点将保持连接：

```ts
import { Surreal } from "@tai-kun/surrealdb";

const db = new Surreal();

await db.connect("ws://localhost:8000");
await db.connect("ws://localhost:1129"); // 抛出 ConnectionConflictError: Connection conflict between ws://localhost:8000/rpc and ws://localhost:1129/rpc.
```

`.connect()` 不会在异步处理的上下文中同时执行，因此以下示例也会导致连接失败。通常，无法确定哪个端点先建立连接，因此错误消息可能会因情况而异：

```ts
import { Surreal } from "@tai-kun/surrealdb";

const db = new Surreal();

await Promise.all([
  db.connect("ws://localhost:8000"),
  db.connect("ws://localhost:1129"),
]); // 抛出 ConnectionConflictError
```

### `.disconnect()` <Badge variant="instance" /><Badge variant="method" />

断开与 SurrealDB 的连接。如果尚未连接或已断开连接，则不会抛出错误。此方法是异步的，但不会与同一实例中的 `.connect()` 或其他 `.disconnect()` 重叠执行。

```ts
disconnect(options?: ClientDisconnectOptions): Promise<void>
```

#### 参数

##### `options`

断开连接时的选项。

`force?: boolean`
:   如果为 `true`，则会向传递给 `Surreal` 对象的事件监听器的中断信号发送中断信号。预期事件监听器即使处理不完整也会立即中断。

`signal?: AbortSignal`
:   连接中断的信号。默认情况下，将设置一个在 15 秒后超时的中断信号。

#### 返回值

返回一个以 `undefined` 解析的 `Promise` 对象。

#### 例子

以下示例使用 WebSocket 协议连接到 SurrealDB，然后断开连接：

```ts
import { Surreal } from "@tai-kun/surrealdb";

const db = new Surreal();

await db.connect("ws://localhost:8000");
await db.disconnect();
```

### `.getConnectionInfo()` <Badge variant="instance" /><Badge variant="method" />

获取连接信息。连接信息始终包含内部信息的副本。因此，连接信息包含 `URL` 对象，但直接修改它不会改变 `Surreal` 对象内部的端点信息。如果尚未请求连接，则为 `undefined`。

```ts
getConnectionInfo(): ConnectionInfo | undefined;
```

#### 参数

无。

#### 返回值

如果连接已建立，则返回连接信息。否则，返回 `undefined`。连接信息包含以下项目：

`state: 0 | 1 | 2 | 3`
:   表示当前连接状态的数字。每个数字表示以下含义：
:   - `0` ... 正在建立连接。
    - `1` ... 连接已建立。
    - `2` ... 正在断开连接。
    - `3` ... 连接已断开。

`endpoint: URL | null`
:   连接的端点。仅在断开连接状态下为 `null`。

`namespace: string | null`
:   当前选择的命名空间。如果没有选择命名空间，则为 `null`。

`database: string | null`
:   当前选择的数据库名称。如果没有选择数据库，则为 `null`。

`token: string | null`
:   当前验证的令牌。如果没有注册或登录，则为 `null`。

每个连接状态下连接信息的取值如下表所示：

| state | endpoint | namespace      | database       | token          |
| ----- | -------- | -------------- | -------------- | -------------- |
| `0`   | `URL`    | `null`         | `null`         | `null`         |
| `1`   | `URL`    | `string\|null` | `string\|null` | `string\|null` |
| `2`   | `URL`    | `string\|null` | `string\|null` | `string\|null` |
| `3`   | `null`   | `null`         | `null`         | `null`         |

### `.state` <Badge variant="instance" /><Badge variant="property" /><Badge variant="readonly" />

表示当前连接状态的数字。

```ts
state: 0 | 1 | 2 | 3
```

每个数字表示以下含义：

- `0` ... 正在建立连接。
- `1` ... 连接已建立。
- `2` ... 正在断开连接。
- `3` ... 连接已断开。

为了方便起见，即使连接尚未建立，它也为 `3`（而不是 `undefined`）。

相关：另请参阅 [`.getConnectionInfo()`](#getconnectioninfo)。

### `.endpoint` <Badge variant="instance" /><Badge variant="property" /><Badge variant="readonly" />

连接的端点。仅在断开连接状态下为 `null`。如果连接尚未建立，则为 `undefined`。

```ts
endpoint: string | null | undefined
```

相关：另请参阅 [`.getConnectionInfo()`](#getconnectioninfo)。

### `.namespace` <Badge variant="instance" /><Badge variant="property" />

当前选择的命名空间。如果没有选择命名空间，则为 `null`。如果连接尚未建立，则为 `undefined`。

```ts
namespace: string | null | undefined
```

相关：另请参阅 [`.getConnectionInfo()`](#getconnectioninfo)。

### `.database` <Badge variant="instance" /><Badge variant="property" />

当前选择的数据库名称。如果连接尚未建立，则为 `undefined`。

```ts
database: string | null | undefined
```

相关：另请参阅 [`.getConnectionInfo()`](#getconnectioninfo)。

### `.token` <Badge variant="instance" /><Badge variant="property" />

当前验证的令牌。如果没有注册或登录，则为 `null`。如果连接尚未建立，则为 `undefined`。

```ts
token: string | null | undefined
```

相关：另请参阅 [`.getConnectionInfo()`](#getconnectioninfo)。

### `.on()` <Badge variant="instance" /><Badge variant="method" />

注册事件监听器。

```ts
off(
  event:
    | 0 | 1 | 2 | 3
    | `rpc_${RpcMethod}_${number}`
    | `live_${string}`
    | "error",
  listener: (taskRunnerArgs, ...eventArgs) => void | PromiseLike<void>,
): void
```

#### 参数

##### `event`

要监视的事件名称。

`0 | 1 | 2 | 3`
:   连接信息发生变化时，或发生变化失败时触发的事件。

`rpc_${RpcMethod}_${number}`
:   双向通信中 RPC 响应触发的事件。目前仅在 WebSocket 协议中使用，在 HTTP 协议中不会使用此事件。`RpcMethod` 例如 `ping` 或 `use` 等 PRC 方法名称。`number` 是双向通信中用于将请求/响应关联的标识符，可以是 1 到 2^53-1 之间的整数。

`live_${string}`
:   收到实时查询的事件时触发的事件。目前仅在 WebSocket 协议中使用，在 HTTP 协议中不会使用此事件。`string` 是实时查询的 UUID。

`error`
:   错误事件。目前仅在 WebSocket 协议中使用，在 HTTP 协议中不会使用此事件。

##### `listener`

事件发生时执行的函数。另请参阅 [任务发射器](/zh-CN/reference/utils/task-emitter#on)。`eventArgs` 中传递的值将根据事件而有所不同。

`0 | 1 | 2 | 3`
:   以下之一：
:   - `{ state: 0 | 1 | 2 | 3 }`
    - `{ state: 0 | 1 | 2 | 3, error: unknown }`

`rpc_${RpcMethod}_${number}`
:   以下之一：
:   - `{ id: string, result: unknown }`
    - `{ id: string, error: { code: number, message: string } }`

`live_${string}`
:   常规模式的实时查询：
:   - `{ action: "CREATE" | "UPDATE" | "DELETE", result: object }`
:   差异获取模式的实时查询：
:   - `{ action: "CREATE" | "UPDATE", result: object[] }`
    - `{ action: "DELETE", result: object }`

`error`
:   以下之一：
:   - [`HttpEngineError`](/zh-CN/reference/errors/#httpengineerror)
    - [`WebSocketEngineError`](/zh-CN/reference/errors/#websocketengineerror)

#### 返回值

无。

### `.once()` <Badge variant="instance" /><Badge variant="method" />

类似于 `.on()`，但只捕获一次事件。

```ts
once(
  event:
    | 0 | 1 | 2 | 3
    | `rpc_${RpcMethod}_${number}`
    | `live_${string}`
    | "error",
  options?: TaskListenerOptions,
): StatefulPromise<unknown[]>
```

#### 参数

##### `event`

与 `.on()` 的 `event` 相同。

##### `options`

任务监听器的选项。请参阅 [任务发射器](/zh-CN/reference/utils/task-emitter#once)。

#### 返回值

返回一个以 `.on()` 的任务监听器的 `eventArgs` 解析的 `StatefulPromise`。

### `.off()` <Badge variant="instance" /><Badge variant="method" />

取消注册由 `.on()` 注册的事件监听器。

```ts
off(
  event:
    | 0 | 1 | 2 | 3
    | `rpc_${RpcMethod}_${number}`
    | `live_${string}`
    | "error",
  listener: (taskRunnerArgs, ...eventArgs) => void | PromiseLike<void>,
): void
```

#### 参数

##### `event`

要取消注册事件监听器的事件名称。

##### `listener`

要取消注册的事件监听器。

#### 返回值

无。
