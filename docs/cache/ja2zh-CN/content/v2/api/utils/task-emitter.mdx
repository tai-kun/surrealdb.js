---
title: 任务发射器
slug: zh-CN/v2/api/utils/task-emitter
---

import Badge from "~/components/zh-CN/Badge.astro";

`TaskEmitter` 是一个事件发射器类，用于管理由 `TaskQueue` 管理的异步任务。

### 导入

```ts
import { TaskEmitter } from "@tai-kun/surrealdb/utils";
```

### `.constructor()`

```ts
new TaskEmitter<T>();
```

#### 参数

##### `T`

一个键值对类型，表示事件名称和事件接受的参数（数组）。

#### 返回值

当通过 `new` 调用时，`TaskEmitter` 会返回其实例。

### `.on()` <Badge variant="instance" /><Badge variant="method" />

`.on` 是一个将事件监听器注册到事件发射器的函数。如果尝试多次将相同函数注册到同一个事件，则除了第一次以外，其他注册将被忽略。

```ts
on(event: string | number, listener: TaskListener): void;
```

#### 参数

##### `event`

要注册事件监听器的事件名称。

##### `listener`

要注册的事件监听器。此函数将接收与 `TaskQueue` 的任务运行器相同的参数，之后将接收可变长度的 `.emit` 传递的参数。

#### 返回值

无。

#### 例子

以下示例将捕获 "log" 事件并将传递给发射器的值输出到标准输出：

```ts
import { TaskEmitter } from "@tai-kun/surrealdb/utils";

type Events = {
  log: string[];
};

const emitter = new TaskEmitter<Events>();

emitter.on("log", (_, ...args) => {
  console.log(...args);
});

emitter.emit("log", "Hello");
emitter.emit("log", "World", "!!!");

await emitter.idle();
```

输出：

```js
Hello
World !!!
```

### `.off()` <Badge variant="instance" /><Badge variant="method" />

`.off` 是一个从事件发射器中取消注册事件监听器的函数。如果省略事件监听器，则将取消注册针对该事件名称注册的所有事件监听器。

```ts
off(event: string | number, listener?: TaskListener): void;
```

#### 参数

##### `event`

要取消注册事件监听器的事件名称。

##### `listener`

要取消注册的事件监听器。如果省略此参数，则将取消注册针对该 `event` 注册的所有事件监听器。

#### 返回值

无。

### `.once()` <Badge variant="instance" /><Badge variant="method" />

`.once` 与 `.on` 相似，但它只捕获一次事件。此外，它不使用回调函数，而是使用返回值 `StatefulPromise` 来接收值。

```ts
once(
  event: string | Number,
  options?: TaskListenerOptions,
): StatefulPromise<unknown[]>;
```

#### 例子

以下示例将只捕获一次 "log" 事件并将传递给发射器的值输出到标准输出：

```ts
import { TaskEmitter } from "@tai-kun/surrealdb/utils";

type Events = {
  log: string[];
};

const emitter = new TaskEmitter<Events>();

const promise = emitter.once("log");

emitter.emit("log", "Hello");
emitter.emit("log", "World", "!!!");

const recived = await promise;
console.log(recived);

await emitter.idle();
```

输出：

```js
[ 'Hello' ]
```

#### 参数

##### `event`

要等待的事件名称。

##### `options`

事件监听器的选项。可以传递中止信号。

#### 返回值

返回一个 `StatefulPromise`，它将使用 `.emit` 的参数（数组）解析。

### `.emit()` <Badge variant="instance" /><Badge variant="method" />

`.emit` 是一个向事件监听器发送值的函数。

```ts
emit(
  event: string | number,
  ...args: unknown[]
): undefined | StatefulPromise<unknown>[];
```

#### 参数

##### `event`

要发送到的事件名称。

##### `args`

要发送到事件监听器的值。

#### 返回值

如果事件监听器不存在，则返回 `undefined`。如果存在事件监听器，则返回一个 `StatefulPromise` 数组，这些 `StatefulPromise` 将一直等待监听器解析或拒绝。通常不需要处理这些 `StatefulPromise`。只有当需要在当前上下文中等待事件触发的副作用，或关心事件监听器的解析或拒绝时，才需要使用它们。

### `.idle()` <Badge variant="instance" /><Badge variant="method" />

`.idle` 是一个等待当前正在运行的所有事件监听器完成的函数。

```ts
idle(): StatefulPromise<void>;
```

#### 参数

无。

#### 返回值

返回一个 `void` 解析的 `StatefulPromise`。

### `.abort()` <Badge variant="instance" /><Badge variant="method" />

`.abort` 是一个向所有事件监听器的 `signal` 发送中止事件的函数。

```ts
abort(reason?: unknown): void;
```

#### 参数

##### `reason`

中止的原因。

#### 返回值

无。
