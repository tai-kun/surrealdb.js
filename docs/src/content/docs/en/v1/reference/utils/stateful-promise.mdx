---
title: StatefulPromise
slug: en/v1/reference/utils/stateful-promise
---

import Badge from "~/components/en/Badge.astro";

`StatefulPromise` is a class that implements `PromiseLike` and does not throw errors when rejected in an unhandled state.

### Import

```ts
import { StatefulPromise } from "@tai-kun/surrealdb/utils";
```

### `.constructor()`

```ts
new StatefulPromise<T>(executor: StatefulPromiseExecutor<T>);
```

#### Arguments

##### `executor`

`executor` serves the same role as the [`executor`](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise/Promise#executor) for the `Promise()` constructor for `StatefulPromise`.

#### Return Value

When called through `new`, `StatefulPromise` returns its instance.

#### Examples

##### Resolved

The following example demonstrates how to wait for a `StatefulPromise` to resolve and receive its result:

```ts
import { StatefulPromise } from "@tai-kun/surrealdb/utils";

const promise = new StatefulPromise(resolve => {
  setTimeout(() => resolve("test"), 0);
});

const result = await promise;

console.log(result); // "test"
```

##### Rejected

The following example demonstrates how to wait for a `StatefulPromise` to reject and expect it to throw an error when handled:

```ts
const promise = new StatefulPromise((_, reject) => {
  setTimeout(() => reject("test"), 0);
});

while (promise.state === "pending") {
  await new Promise(r => setTimeout(r, 50));
}

try {
  await promise;
} catch (e) {
  console.log(e); // "test"
}
```

It is observed that a normal `Promise` would throw an `unhandledrejection` if it is rejected in an unhandled state (i.e., `reject` is called), whereas `StatefulPromise` does not throw an error until it is explicitly handled.

### `.state` <Badge variant="instance" /><Badge variant="property" /><Badge variant="readonly" />

Represents the current state of the `StatefulPromise`. There are three possible states:

- `pending`: Indicates that the promise is pending. It has not yet been resolved or rejected.
- `fulfilled`: Indicates that the promise has been resolved.
- `rejected`: Indicates that the promise has been rejected.

### `.then()` <Badge variant="instance" /><Badge variant="method" />

`.then` takes callback functions for when the `StatefulPromise` succeeds or fails and returns a `StatefulPromise` object.

```ts
then<R1, R2>(
  onFulfilled?: ((value: any) => R1 | PromiseLike<R1>) | undefined | null,
  onRejected?: ((reason: unknown) => R2 | PromiseLike<R2>) | undefined | null,
): StatefulPromise<R1 | R2>;
```

#### Arguments

Same as [`Promise.prototype.then`](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise/then#onfulfilled).

#### Return Value

Returns a `StatefulPromise` object.

### `.resolve()` <Badge variant="static" /><Badge variant="method" />

`.resolve` returns a `StatefulPromise` that is resolved with the given value.

```ts
resolve<T>(value?: T | PromiseLike<T>): StatefulPromise<Awaited<T>>;
```

#### Arguments

##### `value`

The value to resolve with. Defaults to `undefined`.

#### Return Value

Returns a `StatefulPromise` object resolved with the given `value`. If the value is a `StatefulPromise` object, it will return that value.

### `.reject()` <Badge variant="static" /><Badge variant="method" />

`.reject` returns a `StatefulPromise` object that is rejected with the given reason.

```ts
reject<T>(reason?: unknown): StatefulPromise<T>;
```

#### Arguments

##### `reason`

The reason to reject with. Defaults to `undefined`.

#### Return Value

Returns a `StatefulPromise` rejected with the given `reason`.

### `.withResolvers()` <Badge variant="static" /><Badge variant="method" />

`.withResolvers` is a function that returns a new `StatefulPromise` object along with an object containing functions to resolve or reject it.

```ts
withResolvers<T>(): {
  promise: StatefulPromise<T>;
  resolve: (value: T | PromiseLike<T>) => void;
  reject: (reason: unknown) => void;
};
```

#### Arguments

None.

#### Return Value

A plain object containing the following properties:

##### `promise`

A new `StatefulPromise` object.

##### `resolve`

A function to resolve the `promise`.

##### `reject`

A function to reject the `promise`.

### `.try()` <Badge variant="static" /><Badge variant="method" />

`.try` is a function that wraps a function in a `StatefulPromise`.

```ts
try<T, A extends readonly unknown[]>(
  func: (...args: A) => T | PromiseLike<T>,
  ...args: A
): StatefulPromise<T>;
```

#### Arguments

##### `func`

The function to be called. This function can return values other than `StatefulPromise`. It can also throw errors synchronously within the function.

#### Return Value

- If `func` returns a value synchronously, it returns a `StatefulPromise` in a resolved state.
- If `func` throws an error synchronously, it returns a `StatefulPromise` in a rejected state.
- If `func` resolves or rejects asynchronously, it returns a `StatefulPromise` in a pending state.

#### Examples

The following example demonstrates that errors thrown synchronously are captured by the `StatefulPromise`:

```ts
import { StatefulPromise } from "@tai-kun/surrealdb/utils";

const promise = StatefulPromise.try(() => {
  throw "test";
});

await promise.then(null, e => {
  console.log(e); // "test"
});
```

### `.allRejected()` <Badge variant="static" /><Badge variant="method" />

`.allRejected` is a function that collects reasons from `StatefulPromise` objects that were rejected.

```ts
allRejected(promises: Iterable<unknown>): StatefulPromise<unknown[]>;
allRejected<T>(
  promises: Iterable<T>,
  extract: (item: T) => unknown,
): StatefulPromise<unknown[]>;
```

#### Arguments

##### `promises`

An iterable object. It can contain objects other than `StatefulPromise` objects, but they will be considered errors. Likewise, normal `Promise` objects will be ignored.

##### `extract`

A function to extract `StatefulPromise` objects from `promises`.

#### Return Value

Returns a `StatefulPromise` object that is resolved with an array of reasons why `StatefulPromise` objects were rejected.
