---
title: TaskQueue
---

import { Aside } from "@astrojs/starlight/components";
import Badge from "~/components/en/Badge.astro";

The `TaskQueue` class manages asynchronous tasks. It does not provide a way to control concurrency; all task runners execute asynchronously.

### Import

```ts
import { TaskQueue } from "@tai-kun/surrealdb/utils";
```

### `.constructor()`

```ts
new TaskQueue();
```

#### Arguments

None.

#### Return Value

When called via `new`, `TaskQueue` returns its instance.

### `.count` <Badge variant="instance" /><Badge variant="property" /><Badge variant="readonly" />

Represents the number of task runners currently added to the queue.

### `.add()` <Badge variant="instance" /><Badge variant="method" />

`.add` adds a task runner to the queue.

```ts
add<T>(
  runner: (args: TaskRunnerArgs) => T | PromiseLike<T>,
  options?: TaskOptions,
): StatefulPromise<T>;
```

<Aside type="caution">
  If a task runner may take a long time to execute, it is recommended that the task runner immediately terminate when the cancellation signal passed to the task runner receives a cancellation event.
</Aside>

#### Arguments

##### `runner`

The task runner. The task runner's arguments will be passed `TaskRunnerArgs`, which includes the cancellation signal `signal`.

##### `options`

Options for the task runner. The cancellation signal for this task runner can be passed.

#### Return Value

Returns a `StatefulPromise` that resolves with the return value of the task runner.

#### Example

```ts
import { TaskQueue } from "@tai-kun/surrealdb/utils";

const queue = new TaskQueue();
const promise = queue.add(async ({ signal }) => {
  const response = await fetch("https://example.com/", { signal });
  return await response.text();
});

const text = await promise;
console.log(text);
```

### `.idle()` <Badge variant="instance" /><Badge variant="method" />

`.idle` is a function for waiting until the queue is empty. Task runners are removed from the queue immediately after they complete, regardless of whether they resolve or reject. Therefore, an empty queue signifies that all task runners have finished executing.

```ts
idle(): StatefulPromise<void>;
```

<Aside type="caution">
  `.idle` does not catch errors thrown by task runners added with the `.add` method. As task runners are executed within a `StatefulPromise`, you cannot be aware of task runner errors without error handling.
</Aside>

#### Arguments

None.

#### Return Value

Returns a `StatefulPromise` that resolves with `void`.

#### Example

The following example waits until the task runners added to the queue finish, regardless of whether they resolve or reject:

```ts
import { TaskQueue } from "@tai-kun/surrealdb/utils";

const queue = new TaskQueue();
const results: string[] = [];
queue.add(async () => {
  results.push("Hello");
});
queue.add(() => {
  throw null;
});

console.log(queue.count);

await queue.idle();

console.log(queue.count);
console.log(results);
```

Output:

```js
2
0
[ 'Hello' ]
```

In the above example, `throw null` is not caught anywhere and the script exits gracefully. To be aware of task runner errors, you need to handle them individually.

### `.abort()` <Badge variant="instance" /><Badge variant="method" />

`.abort` is a function that sends a cancellation event to the `signal` of all task runners.

```ts
abort(reason?: unknown): void;
```

#### Arguments

##### `reason`

The reason for cancellation.

#### Return Value

None.
