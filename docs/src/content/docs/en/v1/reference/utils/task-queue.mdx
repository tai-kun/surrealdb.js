---
title: TaskQueue
slug: en/v1/reference/utils/task-queue
---

import { Aside } from "@astrojs/starlight/components";
import Badge from "~/components/en/Badge.astro";

`TaskQueue` is a class for managing asynchronous tasks. It does not have a way to control concurrency. All task runners execute asynchronously.

### Import

```ts
import { TaskQueue } from "@tai-kun/surrealdb/utils";
```

### `.constructor()`

```ts
new TaskQueue();
```

#### Arguments

None.

#### Returns

When called through `new`, `TaskQueue` returns its instance.

### `.count` <Badge variant="instance" /><Badge variant="property" /><Badge variant="readonly" />

Represents the number of task runners currently added to the queue.

### `.add()` <Badge variant="instance" /><Badge variant="method" />

`.add` adds a task runner to the queue.

```ts
add<T>(
  runner: (args: TaskRunnerArgs) => T | PromiseLike<T>,
  options?: TaskOptions,
): StatefulPromise<T>;
```

<Aside type="caution">
  If the task runner has the potential to take a long time to run, it is recommended that the task runner immediately terminate when the abort signal passed to it receives an abort event.
</Aside>

#### Arguments

##### `runner`

The task runner. The task runner will be passed `TaskRunnerArgs` which includes an abort signal `signal`.

##### `options`

The options of the task runner. You can pass the abort signal for this task runner.

#### Returns

Returns a `StatefulPromise` that resolves with the return value of the task runner.

#### Example

```ts
import { TaskQueue } from "@tai-kun/surrealdb/utils";

const queue = new TaskQueue();
const promise = queue.add(async ({ signal }) => {
  const response = await fetch("https://example.com/", { signal });
  return await response.text();
});

const text = await promise;
console.log(text);
```

### `.idle()` <Badge variant="instance" /><Badge variant="method" />

`.idle` is a function to wait until the queue is empty. Task runners are removed from the queue immediately after they complete, regardless of whether they resolve or reject. Therefore, an empty queue means that all task runners have finished executing.

```ts
idle(): StatefulPromise<void>;
```

<Aside type="caution">
  `.idle` does not catch errors thrown by task runners added through the `.add` method. Since task runners are executed within `StatefulPromise`, you cannot be aware of errors in the task runner without error handling.
</Aside>

#### Arguments

None.

#### Returns

Returns a `StatefulPromise` that resolves with `void`.

#### Example

The following example waits for the task runners added to the queue to finish, regardless of whether they resolve or reject:

```ts
import { TaskQueue } from "@tai-kun/surrealdb/utils";

const queue = new TaskQueue();
const results: string[] = [];
queue.add(async () => {
  results.push("Hello");
});
queue.add(() => {
  throw null;
});

console.log(queue.count);

await queue.idle();

console.log(queue.count);
console.log(results);
```

Output:

```js
2
0
[ 'Hello' ]
```

In the above example, `throw null` is not caught anywhere and the script exits successfully. To be aware of task runner errors, individual error handling is necessary.

### `.abort()` <Badge variant="instance" /><Badge variant="method" />

`.abort` is a function that sends an abort event to the `signal` of all task runners.

```ts
abort(reason?: unknown): void;
```

#### Arguments

##### `reason`

The reason for the abort.

#### Returns

None.
