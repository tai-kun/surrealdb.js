---
title: Automatic Reconnection
banner:
  content: This is an experimental feature and the API is subject to change.
---

This feature provides automatic reconnection attempts in response to connection interruptions that may occur in real-time communication protocols such as WebSocket. It employs a defined logic to re-establish the connection and emits events indicating success or failure.

The `autoReconnect` function facilitates the use of this reconnection functionality by creating an instance of the `AutoReconnect` class.

### Import

```ts
import { autoReconnect } from "@tai-kun/surrealdb";
```

### Syntax

```ts
function autoReconnect(
  db: Client, 
  options?: AutoReconnectOptions
): AutoReconnect;
```

#### Arguments

##### `db`

This argument represents an instance object of the `Surreal` class.

##### `options`

This parameter allows you to configure reconnection settings. You can specify attributes such as reconnection intervals, maximum delay durations, and reconnection conditions. These options are optional, and the function utilizes default settings if omitted.

`backoffLimit?: number`
:   This option defines the maximum number of reconnection attempts. The default value is `Infinity`.

`initialDelay?: number`
:   This parameter represents the delay (in milliseconds) before the initial reconnection attempt is made. The default value is `500`.

`maxDelay?: number`
:   This option specifies the maximum delay (in milliseconds) for reconnection attempts. As the backoff progresses, the delay increases, but it is capped by this value. The default value is `30_000` (30 seconds).

`shouldReconnect?: { ping?: { threshold: number; perMillis: number }} | (error) => boolean`
:   This parameter defines the conditions for triggering a reconnection attempt. When provided as a function, it determines whether to attempt a reconnection based on the error event arguments.

#### Return Value

The `autoReconnect` function returns an instance of the `AutoReconnect` class. This instance allows for managing reconnections, retrieving status information, and monitoring related events.

`.getReconnectionInfo(): ReconnectionInfo`
:   This method retrieves the current reconnection information, specifically its `.state` and `.phase`. These attributes hold the following meanings:
:   `.state`:
    - `"waiting"` ... Initial state. No reconnection attempts have been made.
    - `"running"` ... Reconnection is in progress.
    - `"success"` ... Reconnection was successful.
    - `"failure"` ... Reconnection attempt failed.
:   `.phase`:
    - `"waiting"`    ... Initial state. No reconnection attempts have been made.
    - `"pending"`    ... Reconnection has been requested and a delay is in place before execution.
    - `"closing"`    ... Disconnection is in progress.
    - `"connecting"` ... Connection is being established. Connection attempts may continue even after disconnection failures.
    - `"succeeded"`  ... Reconnection was successful.
    - `"failed"`     ... Reconnection attempt failed.

| state       | phase                     |
| ----------- | ------------------------- |
| `"waiting"` | `"waiting"\|"pending"`    |
| `"running"` | `"closing"\|"connecting"` |
| `"success"` | `"pending"\|"succeeded"`  |
| `"failure"` | `"pending"\|"failed"`     |

`.enable(): void`
:   This method enables the reconnection feature. Once called, the reconnection mechanism becomes active. By default, it is enabled.

`.disable(): void`
:   This method disables the reconnection feature. Calling this method deactivates the reconnection mechanism.

`.reset(): void`
:   This method resets the reconnection counter. This action initializes the backoff logic for reconnection attempts.

`.enabled: boolean`
:   This property represents a boolean value indicating whether the reconnection feature is enabled. A value of `true` indicates that reconnections are active.

### Example

```ts
import { autoReconnect, Surreal } from "@tai-kun/surrealdb";

const db = new Surreal();
const ar = autoReconnect(db, {
  initialDelay: 1000,
  maxDelay: 30000,
  backoffLimit: 5,
  shouldReconnect: {
    ping: {
      perMillis: 60000, // Within 1 minute,
      threshold: 3,     // If ping fails 3 or more times, reconnect.
    },
  },
});

ar.on("pending", (endpoint, duration) => {
  console.log(`${duration / 1000} seconds until reconnection to ${endpoint}...`);
});

ar.on("success", (endpoint) => {
  console.log(`Reconnection to ${endpoint} was successful ðŸŽ‰`);
});

ar.on("failure", (endpoint, cause) => {
  console.error(`Reconnection to ${endpoint} failed ðŸ¤¯`);
  console.error("Cause:", cause);
});

try {
  await db.connect("ws://127.0.0.1:8000");

  // Various processes that execute over a long duration

} finally {
  await db.close();
}
```

### Notes

- The reconnection logic is crucial for appropriately adjusting the stability and recovery frequency of WebSocket connections. Configuring the options requires tailoring them to the specific requirements and use cases of the system.
- The `autoReconnect` feature is designed to attempt recovery in case of connection loss, but complete recovery cannot be guaranteed in all situations.
